name: sccache

inputs:
  aws-access-key-id:
    required: true
    description: AWS Access Key ID
  aws-secret-access-key:
    required: true
    description: AWS Secret Access Key
  key:
    required: false
    description: Cache key
  workspaces:
    required: false
    description: Workspaces to cache
    default: ". -> target"

runs:
  using: composite
  steps:
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: 'us-west-2'
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}

    - uses: mozilla-actions/sccache-action@v0.0.9
      with:
        disable_annotations: true

    - run: |
        echo "SCCACHE_BUCKET=gear-ci" >> $GITHUB_ENV
        echo "SCCACHE_REGION=us-west-2" >> $GITHUB_ENV
        echo "SCCACHE_S3_KEY_PREFIX=sccache/" >> $GITHUB_ENV
        
        echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      shell: bash

    - run: |
        mkdir -p target/debug/wbuild/ethexe-runtime/target
        mkdir -p target/debug/wbuild/vara-runtime/target
        mkdir -p target/wasm-projects/debug
        mkdir -p target/wasm-projects/release
      shell: bash

    - uses: gear-tech/rust-cache@runs-on
      with:
        prefix-key: 'rust-cache/v0'
        key: ${{ inputs.key }}
        workspaces: |
          ${{ inputs.workspaces }}
          . -> target/debug/wbuild/ethexe-runtime/target
          . -> target/debug/wbuild/vara-runtime/target
          . -> target/wasm-projects/debug
          . -> target/wasm-projects/release
        cache-provider: 's3'
      env:
        RUNS_ON_S3_BUCKET_CACHE: gear-ci
