name: sccache

inputs:
  aws-access-key-id:
    required: true
    description: AWS Access Key ID
  aws-secret-access-key:
    required: true
    description: AWS Secret Access Key
  key:
    required: false
    description: Cache key
  workspaces:
    required: false
    description: Workspaces to cache

runs:
  using: composite
  steps:
    - uses: mozilla-actions/sccache-action@v0.0.9
    - run: |
        echo "SCCACHE_BUCKET=gear-ci" >> $GITHUB_ENV
        echo "SCCACHE_REGION=us-west-2" >> $GITHUB_ENV
        echo "SCCACHE_S3_KEY_PREFIX=sccache/" >> $GITHUB_ENV
        
        echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
        
        echo "AWS_ACCESS_KEY_ID=${{ inputs.aws-access-key-id }}" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=${{ inputs.aws-secret-access-key }}" >> $GITHUB_ENV
      shell: bash
    - uses: gear-tech/rust-cache@s3
      with:
        key: ${{ inputs.key }}
        workspaces: ${{ inputs.workspaces }}
        cache-provider: 's3'
      env:
        SWATINEM_RUST_CACHE_S3_BUCKET: gear-ci
