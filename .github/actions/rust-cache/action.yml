name: rust-cache

inputs:
  us-access-key-id:
    required: true
    description: US S3 access key ID
  us-secret-access-key:
    required: true
    description: US secret access key
  eu-access-key-id:
    required: true
    description: EU S3 access key ID
  eu-secret-access-key:
    required: true
    description: EU secret access key
  key:
    required: false
    description: Cache key

runs:
  using: composite
  steps:
    - run: |
        if [[ "${{ runner.environment }}" == "github-hosted" ]]; then
          echo "AWS_ACCESS_KEY_ID=${{ inputs.us-access-key-id }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ inputs.us-secret-access-key }}" >> $GITHUB_ENV
        else
          echo "AWS_ACCESS_KEY_ID=${{ inputs.eu-access-key-id }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ inputs.eu-secret-access-key }}" >> $GITHUB_ENV
        
          echo "SCCACHE_ENDPOINT=https://fsn1.your-objectstorage.com" >> $GITHUB_ENV
          echo "RUNS_ON_S3_BUCKET_ENDPOINT=https://fsn1.your-objectstorage.com" >> $GITHUB_ENV
        fi
      shell: bash

    - uses: mozilla-actions/sccache-action@v0.0.9
      with:
        disable_annotations: true

    - run: |
        echo "SCCACHE_BUCKET=gear-ci" >> $GITHUB_ENV
        echo "SCCACHE_REGION=auto" >> $GITHUB_ENV
        echo "SCCACHE_S3_KEY_PREFIX=sccache/" >> $GITHUB_ENV
        
        echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      shell: bash

    - run: |
        mkdir -p target/debug/wbuild/ethexe-runtime/target
        mkdir -p target/debug/wbuild/vara-runtime/target
        mkdir -p target/wasm-projects/debug
        mkdir -p target/wasm-projects/release
      shell: bash

    - uses: gear-tech/rust-cache@runs-on
      with:
        prefix-key: 'rust-cache/v0'
        key: ${{ inputs.key }}
        workspaces: |
          . -> target/debug
          . -> target/release
          . -> target/x86_64-unknown-linux-gnu
          . -> target/aarch64-apple-darwin
          . -> target/x86_64-apple-darwin
          . -> target/x86_64-pc-windows-msvc
          . -> target/wasm-projects
          . -> target/wasm32v1-none
          utils/wasm-builder/test-program -> target
          utils/cargo-gbuild/test-program -> target
        cache-provider: 's3'
      env:
        RUNS_ON_S3_BUCKET_CACHE: gear-ci
