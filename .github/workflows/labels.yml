name: Labels
on:
  pull_request:
    branches: [master, vara-stage-1, vara-stage-2, vara-stage-3]
    types: [labeled]

jobs:
  dispatch-build:
    runs-on: ubuntu-latest
    if: contains(fromJSON('["A0-pleasereview", "A2-mergeoncegreen"]'), github.event.label.name)
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            const {
              data: {
                total_count: count,
                workflow_runs: runs,
              }
            } = (await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "CI.yaml",
              branch: "cl/issue-2875"
            }));

            // Get the latest workflow run.
            const cis = runs
              .filter((r) => r.run_attempt == 1 && r.name == "CI")
              .sort((a, b) => b-a);

            if (cis.length == 0) {
              return;
            }

            const run = cis[0];
            const { data: { jobs } } = await github.rest.actions.listJobsForWorkflowRunAttempt({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
              attempt_number: run.run_attempt,
            });

            // Get job ids and trigger build jobs
            const builds = jobs.filter((j) => ["build", "build-win-cross"].includes(j.name));
            for (const job of builds) {
              if (job.status == "skipped") {
                await github.rest.actions.reRunJobForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id,
                });
              }
            }
