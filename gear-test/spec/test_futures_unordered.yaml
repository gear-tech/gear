title: Futures-unordered

programs:
  - id: 1
    path: target/wasm32-unknown-unknown/release/demo_futures_unordered.opt.wasm
    init_message:
      kind: utf-8
      value: "{2},{3}"

  - id: 2
    path: target/wasm32-unknown-unknown/release/demo_async.opt.wasm
    init_message:
      kind: utf-8
      value: "{3},{4},{5}"

  - id: 3
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

  - id: 4
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

  - id: 5
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

fixtures:
  - title: futures-unordered

    messages:
      - destination: 1
        source:
          kind: id
          value: 100
        payload:
          kind: utf-8
          value: unordered

    expected:
      - log:
        # 5 auto replies on init of 5 programs
        - destination: 1000001
          payload: &auto
            kind: bytes
            value: 0x
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0

        - destination: 100
          payload:
            kind: utf-8
            value: PONG
        - destination: 100
          payload:
            kind: utf-8
            value: SUCCESS
        - destination: 100
          payload:
            kind: utf-8
            value: DONE

  - title: select

    messages:
      - destination: 1
        source:
          kind: id
          value: 100
        payload:
          kind: utf-8
          value: select

    expected:
      - log:
        # 5 auto replies on init of 5 programs
        - destination: 1000001
          payload: &auto
            kind: bytes
            value: 0x
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0

        - destination: 100
          payload:
            kind: utf-8
            value: PONG
        - destination: 100
          payload:
            kind: utf-8
            value: DONE

  - title: join

    messages:
      - destination: 1
        source:
          kind: id
          value: 100
        payload:
          kind: utf-8
          value: join

    expected:
      - log:
        # 5 auto replies on init of 5 programs
        - destination: 1000001
          payload: &auto
            kind: bytes
            value: 0x
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0
        - destination: 1000001
          payload: *auto
          statusCode: 0

        - destination: 100
          payload:
            kind: utf-8
            value: SUCCESSPONG
        - destination: 100
          payload:
            kind: utf-8
            value: DONE
